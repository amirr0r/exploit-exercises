# Heap 3

This level introduces the Doug Lea Malloc (`dlmalloc`) and how heap meta data can be modified to change program execution.

This level is at `/opt/protostar/bin/heap3`

```c
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>

void winner()
{
  printf("that wasn't too bad now, was it? @ %d\n", time(NULL));
}

int main(int argc, char **argv)
{
  char *a, *b, *c;

  a = malloc(32);
  b = malloc(32);
  c = malloc(32);

  strcpy(a, argv[1]);
  strcpy(b, argv[2]);
  strcpy(c, argv[3]);

  free(c);
  free(b);
  free(a);

  printf("dynamite failed?\n");
}
```

## Solution

In this level there are no **Use-after-free** vulnerability or application logic we can exploit.
This time, we have to take a look at how heap algorithms work under the hood, and more precisely about Doug Lea malloc (`dlmalloc`) and `unlink()`. 

We know for sure that it is still possible to redirect code execution.

The `unlink()` technique abuses a specific behavior of `free()`.:

![](unlink_definition.png)

```c
#define unlink( P, BK, FD ) {
    [1] BK = P->bk;
    [2] FD = P->fd;
    [3] FD->bk = BK;
    [4] BK->fd = FD;
}
```

- `P` is the chunk that will be linked.
- `BK` (backward) and `FD` (forward) are temporary pointers.

They're used to optimization in case we want to free a chunk and the previous chunk is freed, if this chunk is not the last remainder, the previous chunk is taken off its doubly-linked list via `unlink()` and consolidated with the chunk being freed. 

If an attacker can control `P->bk` and `P->fk`, it can result to a **write-what-where** situation.

> **Note**: nowadays this technique will no longer work, because **GLIBC**'s `malloc()` implementation has been hardened over the years.

First, there is an obvious overflow with `strcpy()` since it takes `argv` as parameters while dealing with 32 bytes strings.

The objective is to overwrite `puts` address in the **GOT** to call the `winner()` function instead of printing "dynamite failed?". 

> TODO...

## Useful links

- <http://phrack.org/issues/57/8.html#article>
- <http://phrack.org/issues/57/9.html#article>